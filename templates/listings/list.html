{% extends "base.html" %}
{% load humanize %}

{% block title %}Browse EV Listings - EV Marketplace{% endblock %}

{% block content %}
<header class="flex-between" style="margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
    <div>
        <h1>Browse EV Listings</h1>
        <p class="muted">Search approved inventory from dealers and private sellers across Canada.</p>
    </div>
    <div>
        <a class="contrast" href="{% url 'sell' %}">List your EV</a>
    </div>
</header>
{% if selected_dealer %}
<article style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--muted-border-color); border-radius: 0.75rem; background: rgba(0, 123, 255, 0.05); display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
    <div>
        <strong>Showing inventory from {{ selected_dealer.name }}</strong><br />
        <small class="muted">{{ selected_dealer.city }}, {{ selected_dealer.province }}</small>
    </div>
    <div>
        {% if querystring_without_dealer %}
            <a class="secondary" href="?{{ querystring_without_dealer }}">Clear dealer filter</a>
        {% else %}
            <a class="secondary" href="{% url 'listings:list' %}">Clear dealer filter</a>
        {% endif %}
    </div>
</article>
{% endif %}

<form method="get" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <p class="muted" style="grid-column: 1 / -1; margin: 0;">Use Ctrl (Windows) or Command (Mac) to select multiple options.</p>
    <label>
        <span>Keyword</span>
        <input type="search" name="q" placeholder="Make, model, city." value="{{ filters.query }}" />
    </label>
    <label>
        <span>Make</span>
        <select name="make" multiple size="4">
            <option value="">Any make</option>
            {% for make in filter_options.makes %}
                <option value="{{ make }}" {% if make in filters.makes %}selected{% endif %}>{{ make }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <span>Province</span>
        <select name="province" multiple size="5">
            <option value="">Anywhere</option>
            {% for code, name in filter_options.provinces %}
                <option value="{{ code }}" {% if code in filters.provinces %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <span>Drivetrain</span>
        <select name="drivetrain" multiple size="3">
            <option value="">Any</option>
            {% for code, name in filter_options.drivetrains %}
                <option value="{{ code }}" {% if code in filters.drivetrains %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <span>DC Fast Charge</span>
        <select name="charge_type" multiple size="4">
            <option value="">Any</option>
            {% for code, name in filter_options.charge_types %}
                <option value="{{ code }}" {% if code in filters.charge_types %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <span>Year (min)</span>
        <select name="year_min">
            <option value="">Any</option>
            {% for year in filter_options.years %}
                <option value="{{ year }}" {% if filters.year_min == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <span>Year (max)</span>
        <select name="year_max">
            <option value="">Any</option>
            {% for year in filter_options.years %}
                <option value="{{ year }}" {% if filters.year_max == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <span>Price min</span>
        <input type="number" inputmode="numeric" step="1000" min="0" name="price_min" value="{{ filters.price_min }}" />
    </label>
    <label>
        <span>Price max</span>
        <input type="number" inputmode="numeric" step="1000" min="0" name="price_max" value="{{ filters.price_max }}" />
    </label>
    <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
        <button type="submit" class="contrast">Search</button>
        <a class="secondary" href="{% url 'listings:list' %}">Reset</a>
    </div>
</form>


{% if feature_saved_searches and user.is_authenticated and save_search_form %}
<form method="post" action="{% url 'listings:save_search' %}" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1rem; align-items: flex-end;">
    {% csrf_token %}
    {{ save_search_form.querystring }}
    <label>
        <span>Save this search</span>
        {{ save_search_form.name }}
        {% if save_search_form.errors.name %}<small class="error">{{ save_search_form.errors.name|join:', ' }}</small>{% endif %}
    </label>
    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
    <button type="submit" class="secondary">Save search</button>
</form>
{% elif feature_saved_searches and not user.is_authenticated %}
<p class="muted" style="margin-top: 1rem;">Sign in to save your favourite filter combinations.</p>
{% endif %}
{% if feature_saved_searches and user.is_authenticated and not save_search_form %}
<p class="muted" style="margin-top: 1rem;">Adjust your filters to save a custom search.</p>
{% endif %}

{% if feature_saved_searches and saved_searches %}
    <section style="margin-top: 1.5rem;">
        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Saved searches</h2>
        <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem;">
            {% for saved in saved_searches %}
                {% with url='?'|add:saved.querystring %}
                <li style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; flex-wrap: wrap;">
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <a href="{{ url }}">{{ saved.name|default:saved.summary }}</a>
                        <small class="muted">{{ saved.summary }}</small>
                    </div>
                    <form method="post" action="{% url 'listings:delete_saved_search' saved.pk %}" style="display: flex; align-items: center; gap: 0.5rem;">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                        <button type="submit" class="secondary" style="padding: 0.25rem 0.75rem;">Delete</button>
                    </form>
                </li>
                {% endwith %}
            {% endfor %}
        </ul>
    </section>
{% endif %}


{% if listings %}
    <section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
        {% for listing in listings %}
            {% include "listings/partials/listing_card.html" with listing=listing %}
        {% endfor %}
    </section>

    {% if is_paginated %}
        <nav class="container" style="margin-top: 2rem; display: flex; justify-content: center;">
            {% with base=querystring_without_page %}
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; align-items: center;">
                {% if page_obj.has_previous %}
                    <a class="secondary" href="?{% if base %}{{ base }}&{% endif %}page=1" aria-label="First page">First</a>
                    <a class="secondary" href="?{% if base %}{{ base }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous page">Previous</a>
                {% else %}
                    <span class="secondary" aria-disabled="true" style="opacity: 0.6; pointer-events: none;">First</span>
                    <span class="secondary" aria-disabled="true" style="opacity: 0.6; pointer-events: none;">Previous</span>
                {% endif %}
                {% for item in pagination_links %}
                    {% if item.is_ellipsis %}
                        <span class="muted" aria-hidden="true">&hellip;</span>
                    {% else %}
                        {% if item.is_current %}
                            <span class="contrast" aria-current="page">{{ item.number }}</span>
                        {% else %}
                            <a class="secondary" href="?{% if base %}{{ base }}&{% endif %}page={{ item.number }}">{{ item.number }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                    <a class="secondary" href="?{% if base %}{{ base }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next page">Next</a>
                    <a class="secondary" href="?{% if base %}{{ base }}&{% endif %}page={{ page_obj.paginator.num_pages }}" aria-label="Last page">Last</a>
                {% else %}
                    <span class="secondary" aria-disabled="true" style="opacity: 0.6; pointer-events: none;">Next</span>
                    <span class="secondary" aria-disabled="true" style="opacity: 0.6; pointer-events: none;">Last</span>
                {% endif %}
            </div>
            {% endwith %}
        </nav>
    {% endif %}
{% else %}
    <article style="margin-top: 2rem;">
        <h2>No listings match your filters</h2>
        <p class="muted">Try broadening your search or clearing filters.</p>
    </article>
{% endif %}
{% endblock %}
